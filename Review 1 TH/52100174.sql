USE MASTER
IF EXISTS (SELECT * FROM SYSDATABASES WHERE NAME='TRANQUANGDANG_52100174')
DROP DATABASE TRANQUANGDANG_52100174
GO
CREATE DATABASE TRANQUANGDANG_52100174
GO
USE TRANQUANGDANG_52100174
GO
IF EXISTS (SELECT * FROM SYSOBJECTS  WHERE NAME='KETQUA')
DROP TABLE KETQUA;
GO
CREATE TABLE KETQUA (
  -- MASV VARCHAR(255) NOT NULL,
  -- MAMH VARCHAR(255) NOT NULL,
  -- LANTHI INT NOT NULL,
  MASV VARCHAR(255),
  MAMH VARCHAR(255),
  LANTHI INT,
  DIEM FLOAT,
  PRIMARY KEY (MASV,MAMH,LANTHI)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS  WHERE NAME = 'DMKHOA')
DROP TABLE DMKHOA
GO
CREATE TABLE DMKHOA (
  MAKHOA VARCHAR(255) NOT NULL,
  TENKHOA NVARCHAR(255),
  PRIMARY KEY (MAKHOA)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME = 'DMSV')
DROP TABLE DMSV
GO
CREATE TABLE DMSV (
  MASV VARCHAR(255) NOT NULL,
  HOSV NVARCHAR(255),
  TENSV NVARCHAR(255),
  PHAI INT,
  NGAYSINH DATE,
  NOISINH NVARCHAR(255),
  MAKHOA VARCHAR(255),
  HOCBONG INT,
  -- SOMH INT,
  PRIMARY KEY (MASV)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DMMH')
DROP TABLE DMMH
GO
CREATE TABLE DMMH(
  MAMH VARCHAR(255) NOT NULL,
  TENMH NVARCHAR(255),
  SOTIET INT,
  PRIMARY KEY (MAMH)
)


--ADD DATA
INSERT INTO DMMH VALUES('01',N'CƠ SỞ DỮ LIỆU',45)
INSERT INTO DMMH VALUES('02',N'TRÍ TUỆ NHÂN TẠO',45)
INSERT INTO DMMH VALUES('03',N'TRUYỀN TIN',45)
INSERT INTO DMMH VALUES('04',N'ĐỒ HOẠ',60)
INSERT INTO DMMH VALUES('05',N'VĂN PHẠM',60)
INSERT INTO DMMH VALUES('06',N'KỸ THUẬT LẬP TRÌNH',45)
SELECT * FROM DMMH


INSERT INTO DMKHOA VALUES('AV',N'ANH VĂN')
INSERT INTO DMKHOA VALUES('TH',N'TIN HỌC')
INSERT INTO DMKHOA VALUES('TR',N'TRIẾT')
INSERT INTO DMKHOA VALUES('VL',N'VẬT LÝ')

SELECT * FROM DMKHOA


SET DATEFORMAT DMY

INSERT INTO DMSV VALUES('A01',N'NGUYỄN THỊ',N'HẢI',1,'23/02/1993',N'HÀ NỘI','TH',130000)
INSERT INTO DMSV VALUES('A02',N'TRẦN VĂN',N'CHÍNH',0,'24/12/1992',N'BÌNH ĐỊNH','VL',150000)
INSERT INTO DMSV VALUES('A03',N'LÊ THU BẠCH',N'YẾN',1,'21/02/1993',N'TPHCM','TH',170000)
INSERT INTO DMSV VALUES('A04',N'TRẦN ANH',N'TUẤN',0,'20/12/1994',N'HÀ NỘI','AV',80000)
INSERT INTO DMSV VALUES('B01',N'TRẦN THANH',N'MAI',1,'12/08/1993',N'HẢI PHÒNG','TR',0)
INSERT INTO DMSV VALUES('B02',N'TRẦN THỊ THU',N'THUỶ',1,'02/01/1994',N'TPHCM','AV',0)


SELECT * FROM DMSV


INSERT INTO KETQUA VALUES('A01','01',1,3)
INSERT INTO KETQUA VALUES('A01','01',2,6)
INSERT INTO KETQUA VALUES('A01','02',2,6)
INSERT INTO KETQUA VALUES('A01','03',1,5)
INSERT INTO KETQUA VALUES('A02','01',1,4.5)
INSERT INTO KETQUA VALUES('A02','01',2,7)
INSERT INTO KETQUA VALUES('A02','03',1,10)
INSERT INTO KETQUA VALUES('A02','05',1,9)

INSERT INTO KETQUA VALUES('A03','01',1,2)
INSERT INTO KETQUA VALUES('A03','01',2,5)
INSERT INTO KETQUA VALUES('A03','03',1,2.5)
INSERT INTO KETQUA VALUES('A03','05',2,4)
INSERT INTO KETQUA VALUES('A04','05',2,10)

INSERT INTO KETQUA VALUES('B01','01',1,7)
INSERT INTO KETQUA VALUES('B01','03',1,2.5)
INSERT INTO KETQUA VALUES('B01','03',2,5)

INSERT INTO KETQUA VALUES('B02','02',1,6)
INSERT INTO KETQUA VALUES('B02','04',1,10)
SELECT * FROM KETQUA


---A
--1
SELECT MASV,HOSV+' '+TENSV AS TENSV,PHAI,NGAYSINH
FROM DMSV AS SV,DMKHOA AS K
WHERE SV.MAKHOA=K.MAKHOA AND TENKHOA LIKE N'TIN HỌC'

--2
SELECT * FROM DMSV
ORDER BY PHAI
--3
SELECT MASV,HOSV+' '+TENSV AS HOTEN,DATEDIFF(YEAR,NGAYSINH,GETDATE()) AS NAMSINH
FROM DMSV
WHERE DATEDIFF(YEAR,NGAYSINH,GETDATE())>=18
--4
SELECT MASV,HOSV+' '+TENSV AS HOTEN
FROM DMSV
WHERE MASV NOT IN (
	SELECT K.MASV
	FROM KETQUA AS K,DMMH AS H
	WHERE K.MAMH=H.MAMH AND TENMH LIKE N'CAU TRUC DU LIEU'
)

--5
SELECT MASV,HOSV+' '+TENSV AS HOTEN
FROM DMSV
WHERE MASV IN (
	SELECT K.MASV
	FROM KETQUA AS K,DMMH AS H
	WHERE K.MAMH=H.MAMH AND TENMH LIKE N'CAU TRUC DU LIEU'
	GROUP BY K.MASV,K.MASV,DIEM
	HAVING COUNT(LANTHI)=1 AND DIEM<5
)

--6

SELECT HOSV+' '+TENSV AS HOTEN,KQ.MAMH,LANTHI,
		RESULT=(
			CASE WHEN DIEM>5 THEN 'DAU' ELSE 'ROT' END
		)
FROM DMSV AS SV,KETQUA AS KQ
WHERE SV.MASV=KQ.MASV


--7
SELECT NOISINH
FROM DMSV
GROUP BY NOISINH
HAVING COUNT(NOISINH)=2
 
--8
SELECT MASV,HOSV+' '+TENSV AS HOTEN
FROM DMSV
WHERE MASV IN (
	SELECT MASV
	FROM KETQUA
	WHERE DIEM<5 AND LANTHI=1
	GROUP BY MASV,LANTHI
	HAVING COUNT(DIEM)=2
)
--9 CHECK LAI

SELECT MASV,HOSV+' '+TENSV AS HOTEN
FROM DMSV
WHERE MASV IN (
	SELECT KQ.MASV
	FROM KETQUA AS KQ,DMKHOA AS K,DMMH AS MH,DMSV AS SV
	WHERE LANTHI=1 AND TENMH LIKE N'VĂN PHẠM' 
			AND MH.MAMH=KQ.MAMH 
			AND SV.MAKHOA=K.MAKHOA 
			AND TENKHOA	LIKE N'ANH VĂN'
	GROUP BY KQ.MASV,DIEM
	HAVING KQ.DIEM=MIN(DIEM)
)
--10

SELECT MASV,HOSV+' '+TENSV AS HOTEN
FROM DMSV
WHERE HOCBONG>(
	SELECT SUM(HOCBONG)
	FROM DMSV AS SV,DMKHOA AS K
	WHERE SV.MAKHOA=K.MAKHOA AND TENKHOA LIKE N'ANH VĂN'
)

--11
SELECT MASV,HOSV+' '+TENSV AS HOTEN
FROM DMSV AS SV,DMKHOA AS K
WHERE MASV NOT IN(
	SELECT KQ.MASV
	FROM DMMH AS MH,KETQUA AS KQ
	WHERE KQ.MAMH=MH.MAMH AND TENMH LIKE N'VĂN PHẠM'

)
AND SV.MAKHOA = K.MAKHOA AND TENKHOA LIKE N'ANH VĂN'

---B

--1
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='KTSINHVIEN')
BEGIN
	DROP FUNCTION KTSINHVIEN
END
GO
CREATE FUNCTION KTSINHVIEN(@MASV VARCHAR(255),@MAKHOA VARCHAR(255))
RETURNS BIT
AS
BEGIN
	IF EXISTS(SELECT * FROM DMSV WHERE @MASV=MASV AND @MAKHOA=@MAKHOA)
	BEGIN
		RETURN 1
	END
	RETURN 0
END
GO

PRINT DBO.KTSINHVIEN('A01','TH')

--2
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='GETDIEM')
BEGIN
	DROP FUNCTION GETDIEM
END
GO
CREATE FUNCTION GETDIEM(@MASV VARCHAR(255),@MAMH VARCHAR(255))
RETURNS FLOAT
AS
BEGIN
	DECLARE @MAXLANTHI INT
	SELECT @MAXLANTHI=MAX(LANTHI)
	FROM KETQUA
	WHERE @MASV=MASV AND @MAMH=MAMH

	DECLARE @ENDDIEM FLOAT
	SELECT @ENDDIEM=DIEM
	FROM KETQUA
	WHERE @MASV=MASV AND @MAMH=MAMH AND LANTHI=@MAXLANTHI

	RETURN @ENDDIEM

END
GO
SELECT DBO.GETDIEM('A01','01') AS DIEM

--3
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='GETDIEMTB')
BEGIN
	DROP FUNCTION GETDIEMTB
END
GO
CREATE FUNCTION GETDIEMTB(@MASV VARCHAR(255))
RETURNS FLOAT
AS
BEGIN
	DECLARE @DIEMTONG FLOAT
	SET @DIEMTONG=0
	DECLARE @TONGSOMON INT

	SELECT @TONGSOMON=COUNT(LANTHI)
	FROM KETQUA
	WHERE @MASV=MASV
	GROUP BY MASV



	SELECT @DIEMTONG+=DBO.GETDIEM(@MASV,MAMH)
	FROM KETQUA
	WHERE @MASV=MASV
	GROUP BY MAMH

	RETURN @DIEMTONG/@TONGSOMON

END

GO
SELECT DBO.GETDIEMTB('A01') AS DIEMTB


--4
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='GETDIEM1')
BEGIN
  DROP FUNCTION GETDIEM1
END
GO


CREATE FUNCTION GETDIEM1(@MASV VARCHAR(255), @MAMH VARCHAR(255), @LANTHI INT)
RETURNS FLOAT
AS
BEGIN
  DECLARE @DIEM FLOAT
  SELECT @DIEM=DIEM FROM KETQUA WHERE MASV=@MASV AND MAMH=@MAMH AND LANTHI=@LANTHI
  RETURN @DIEM
END
GO

IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME = 'INDIEMLANTHI')
BEGIN
  DROP FUNCTION INDIEMLANTHI
END
GO

CREATE FUNCTION INDIEMLANTHI(@MASV VARCHAR(255),@MAMH VARCHAR(255))
AS
BEGIN
  DECLARE @MAX_LANTHI INT

  SELECT @MAX_LANTHI=MAX(LANTHI)
  FROM KETQUA
  WHERE @MASV=MASV AND @MAMH=MAMH

  DECLARE @I INT
  SET @I=1


  WHILE @I<=@MAX_LANTHI
    BEGIN
      PRINT 'LAN '+CONVERT(VARCHAR(255),@I)+': '+CONVERT(VARCHAR(255),DBO.GETDIEM1(MASV,@MAMH,@I))
      SET @I+=1
    END
END
GO







