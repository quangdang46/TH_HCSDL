USE master
GO

IF EXISTS(SELECT * FROM SYSDATABASES WHERE NAME='QLSV')
DROP DATABASE QLSV
GO

CREATE DATABASE QLSV
GO

USE QLSV
GO


IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='DEPARTMENT')
DROP TABLE DEPARTMENT
GO

CREATE TABLE DEPARTMENT(
	DID VARCHAR(30) PRIMARY KEY,
	DNAME VARCHAR(30),
	DYEAR INT,
)
GO

IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='STUDENT')
DROP TABLE STUDENT
GO

CREATE TABLE STUDENT (
	SID VARCHAR(30) PRIMARY KEY,
	NAME NVARCHAR(30) NOT NULL,
	BIRTHDAY VARCHAR(10),
	DID VARCHAR(30),
	FOREIGN KEY (DID) REFERENCES DEPARTMENT(DID),
)

GO

IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='COURSES')
DROP TABLE COURSES
GO

CREATE TABLE COURSES (
	CID VARCHAR(30) PRIMARY KEY,
	CNAME VARCHAR(30),
	CREDIT INT,
	DID VARCHAR(30),
	FOREIGN KEY (DID) REFERENCES DEPARTMENT(DID),
)

GO

IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='CONDITION')
DROP TABLE CONDITION
GO

CREATE TABLE CONDITION (
	CID VARCHAR(30),
	PRECID VARCHAR(30),
	PRIMARY KEY (CID ,PRECID),
	FOREIGN KEY (CID) REFERENCES COURSES(CID),
	FOREIGN KEY (PRECID) REFERENCES COURSES(CID),
)

GO

IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='RESULTS')
DROP TABLE RESULTS
GO

CREATE TABLE RESULTS (
	SID VARCHAR(30),
	CID VARCHAR(30),
	SCORE FLOAT,
	--PRIMARY KEY(SID,CID),
	FOREIGN KEY (CID) REFERENCES COURSES(CID),
	FOREIGN KEY (SID) REFERENCES STUDENT(SID),
)
-- LAB 2
--P1
-- DEPARTMENT
INSERT INTO DBO.DEPARTMENT VALUES('IT','Information Technology',2012)
INSERT INTO DBO.DEPARTMENT VALUES('ET','Electronic Technology',1997)
INSERT INTO DBO.DEPARTMENT VALUES('BT','Biotechnology',1997)
INSERT INTO DBO.DEPARTMENT VALUES('FL','Foreign language',2000)
INSERT INTO DBO.DEPARTMENT VALUES('CT','Chemical Technology',2011)

--SELECT * FROM DBO.DEPARTMENT
--STUDENT
INSERT INTO DBO.STUDENT VALUES('S01',N'Phước Trần','1990-02-24','IT')
INSERT INTO DBO.STUDENT VALUES('S02',N'Timothy','2000-12-12','IT')
INSERT INTO DBO.STUDENT VALUES('S03',N'Kaily','2001-10-01','ET')
INSERT INTO DBO.STUDENT VALUES('S04',N'Tâm Nguyễn','1998-12-20','ET')
INSERT INTO DBO.STUDENT VALUES('S05',N'Lee Nguyễn','1999-02-28','BT')

--SELECT * FROM DBO.STUDENT

--COURSES
INSERT INTO DBO.COURSES VALUES('OOP','Object oriented Programming',4,'IT')
INSERT INTO DBO.COURSES VALUES('PM','Programming method',4,'IT')
INSERT INTO DBO.COURSES VALUES('DBS','Database system',4,'IT')
INSERT INTO DBO.COURSES VALUES('SE','Software engineering',4,'IT')
INSERT INTO DBO.COURSES VALUES('CN','Computer network',3,'IT')

--SELECT * FROM DBO.COURSES

--CONDITION
INSERT INTO DBO.CONDITION VALUES('OOP','PM')
INSERT INTO DBO.CONDITION VALUES('DBS','PM')
INSERT INTO DBO.CONDITION VALUES('DBS','OOP')
INSERT INTO DBO.CONDITION VALUES('SE','OOP')
INSERT INTO DBO.CONDITION VALUES('SE','DBS')

--SELECT * FROM DBO.CONDITION

--RESULTS

INSERT INTO DBO.RESULTS VALUES('S01','PM',9.5)
--INSERT INTO DBO.RESULTS VALUES('S01','OOP',10)
INSERT INTO DBO.RESULTS VALUES('S02','PM',4.5)
INSERT INTO DBO.RESULTS VALUES('S02','DBS',6)
INSERT INTO DBO.RESULTS VALUES('S03','DBS',8)

--SELECT * FROM DBO.RESULTS

--P2
UPDATE DBO.STUDENT SET BIRTHDAY='1999-02-20' WHERE SID='S01'
--SELECT * FROM DBO.STUDENT
UPDATE DBO.RESULTS SET SCORE+=1 WHERE SID='S01'
--SELECT * FROM DBO.RESULTS
DELETE DBO.RESULTS WHERE SCORE < 5
--SELECT * FROM DBO.RESULTS
--P3
--A
ALTER TABLE DBO.STUDENT ADD PHONE INT
--SELECT * FROM DBO.STUDENT
--B
ALTER TABLE DBO.STUDENT ALTER COLUMN PHONE VARCHAR(10)
--SELECT * FROM DBO.STUDENT
--C
ALTER TABLE DBO.STUDENT ADD DEFAULT 'NONE' FOR PHONE
--SELECT * FROM DBO.STUDENT


--D
--LOAI BO NULL TRUOC KHI SET PRIMARY KEY ,CMT DONG 120 VI SET KHOA CHINH KHONG TRUNG KEY
ALTER TABLE DBO.RESULTS ALTER COLUMN SID VARCHAR(30) NOT NULL
ALTER TABLE DBO.RESULTS ALTER COLUMN CID VARCHAR(30) NOT NULL
ALTER TABLE DBO.RESULTS ADD PRIMARY KEY (SID,CID)



--E
--kiem tra ton tai 
IF COL_LENGTH('DBO.STUDENT','SID') IS NOT NULL
	ALTER TABLE DBO.RESULTS
	ADD FOREIGN KEY (SID) REFERENCES DBO.STUDENT(SID)
IF COL_LENGTH('DBO.COURSES','CID') IS NOT NULL
	ALTER TABLE DBO.RESULTS
	ADD FOREIGN KEY (CID) REFERENCES DBO.COURSES(CID)


--SELECT * FROM DBO.RESULTS

--F
--XOA GT LOI TRUOC KHI ADD CHECK
DELETE DBO.RESULTS WHERE SCORE<0 OR SCORE > 10
ALTER TABLE DBO.RESULTS
--ADD CHECK (SCORE >= 0 AND SCORE <= 10)
ADD CONSTRAINT CHK_SCORE CHECK (SCORE >= 0 AND SCORE <= 10)

DELETE DBO.COURSES WHERE CREDIT<1 OR CREDIT > 12
ALTER TABLE DBO.COURSES
ADD CHECK (CREDIT >= 1 AND CREDIT <= 12)

ALTER TABLE DBO.COURSES ADD UNIQUE (CNAME)

--G
--xoa CONSTRAINT con thua
ALTER TABLE DBO.STUDENT DROP CONSTRAINT DF__STUDENT__PHONE__30F848ED
ALTER TABLE DBO.STUDENT DROP COLUMN PHONE
--SELECT * FROM DBO.STUDENT

--h
ALTER TABLE DBO.COURSES
DROP CONSTRAINT CHK_SCORE









