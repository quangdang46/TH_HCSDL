USE MASTER
IF EXISTS (SELECT * FROM SYSDATABASES WHERE NAME='CSDL' )
DROP DATABASE CSDL
GO
CREATE DATABASE CSDL
GO
USE CSDL
GO
IF EXISTS (SELECT * FROM SYSOBJECTS  WHERE NAME='KETQUA')
DROP TABLE KETQUA;
GO
CREATE TABLE KETQUA (
  -- MASV VARCHAR(255) NOT NULL,
  -- MAMH VARCHAR(255) NOT NULL,
  -- LANTHI INT NOT NULL,
  MASV VARCHAR(255),
  MAMH VARCHAR(255),
  LANTHI INT,
  DIEM FLOAT,
  -- PRIMARY KEY (MASV,MAMH,LANTHI)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS  WHERE NAME = 'DMKHOA')
DROP TABLE DMKHOA
GO
CREATE TABLE DMKHOA (
  MAKHOA VARCHAR(255) NOT NULL,
  TENKHOA NVARCHAR(255),
  PRIMARY KEY (MAKHOA)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME = 'DMSV')
DROP TABLE DMSV
GO
CREATE TABLE DMSV (
  MASV VARCHAR(255) NOT NULL,
  HOSV NVARCHAR(255),
  TENSV NVARCHAR(255),
  PHAI INT,
  NGAYSINH DATE,
  NOISINH NVARCHAR(255),
  MAKHOA VARCHAR(255),
  HOCBONG INT,
  -- SOMH INT,
  PRIMARY KEY (MASV)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DMMH')
DROP TABLE DMMH
GO
CREATE TABLE DMMH(
  MAMH VARCHAR(255) NOT NULL,
  TENMH NVARCHAR(255),
  SOTIET INT,
  PRIMARY KEY (MAMH)
)

ALTER TABLE KETQUA ALTER COLUMN MASV VARCHAR(255) NOT NULL
ALTER TABLE KETQUA ALTER COLUMN MAMH VARCHAR(255) NOT NULL
ALTER TABLE KETQUA ALTER COLUMN LANTHI INT NOT NULL
GO
ALTER TABLE KETQUA ADD CONSTRAINT KQ_PK PRIMARY KEY (MASV, MAMH, LANTHI)
ALTER TABLE KETQUA ADD CONSTRAINT KQ_MASV_FK FOREIGN KEY(MASV) REFERENCES DMSV(MASV) 
ALTER TABLE KETQUA ADD CONSTRAINT KQ_MAMH_FK FOREIGN KEY(MAMH) REFERENCES DMMH(MAMH)

--3.1
ALTER TABLE DMKHOA ADD NAMTL INT
--3.2
ALTER TABLE DMKHOA ALTER COLUMN NAMTL SMALLINT
--3.3
EXEC SP_RENAME 'DMKHOA.NAMTL','NAMTHANHLAP' 
--3.4 
ALTER TABLE DMKHOA DROP COLUMN NAMTHANHLAP
--3.6
ALTER TABLE DMSV ADD CONSTRAINT FK_DMSV_KHOA FOREIGN KEY(MAKHOA) REFERENCES DMKHOA(MAKHOA)
--3.5
ALTER TABLE DMSV DROP FK_DMSV_KHOA


--ADD DATA
INSERT INTO DMMH VALUES('01',N'CƠ SỞ DỮ LIỆU',45)
INSERT INTO DMMH VALUES('02',N'TRÍ TUỆ NHÂN TẠO',45)
INSERT INTO DMMH VALUES('03',N'TRUYỀN TIN',45)
INSERT INTO DMMH VALUES('04',N'ĐỒ HOẠ',60)
INSERT INTO DMMH VALUES('05',N'VĂN PHẠM',60)
INSERT INTO DMMH VALUES('06',N'KỸ THUẬT LẬP TRÌNH',45)
SELECT * FROM DMMH


INSERT INTO DMKHOA VALUES('AV',N'ANH VĂN')
INSERT INTO DMKHOA VALUES('TH',N'TIN HỌC')
INSERT INTO DMKHOA VALUES('TR',N'TRIẾT')
INSERT INTO DMKHOA VALUES('VL',N'VẬT LÝ')
SELECT * FROM DMKHOA


SET DATEFORMAT DMY

INSERT INTO DMSV VALUES('A01',N'NGUYỄN THỊ',N'HẢI',1,'23/02/1993',N'HÀ NỘI','TH',130000)
INSERT INTO DMSV VALUES('A02',N'TRẦN VĂN',N'CHÍNH',0,'24/12/1992',N'BÌNH ĐỊNH','VL',150000)
INSERT INTO DMSV VALUES('A03',N'LÊ THU BẠCH',N'YẾN',1,'21/02/1993',N'TPHCM','TH',170000)
INSERT INTO DMSV VALUES('A04',N'TRẦN ANH',N'TUẤN',0,'20/12/1994',N'HÀ NỘI','AV',80000)
INSERT INTO DMSV VALUES('B01',N'TRẦN THANH',N'MAI',1,'12/08/1993',N'HẢI PHÒNG','TR',0)
INSERT INTO DMSV VALUES('B02',N'TRẦN THỊ THU',N'THUỶ',1,'02/01/1994',N'TPHCM','AV',0)
SELECT * FROM DMSV


INSERT INTO KETQUA VALUES('A01','01',1,3)
INSERT INTO KETQUA VALUES('A01','01',2,6)
INSERT INTO KETQUA VALUES('A01','02',2,6)
INSERT INTO KETQUA VALUES('A01','03',1,5)
INSERT INTO KETQUA VALUES('A02','01',1,4.5)
INSERT INTO KETQUA VALUES('A02','01',2,7)
INSERT INTO KETQUA VALUES('A02','03',1,10)
INSERT INTO KETQUA VALUES('A02','05',1,9)

INSERT INTO KETQUA VALUES('A03','01',1,2)
INSERT INTO KETQUA VALUES('A03','01',2,5)
INSERT INTO KETQUA VALUES('A03','03',1,2.5)
INSERT INTO KETQUA VALUES('A03','05',2,4)
INSERT INTO KETQUA VALUES('A04','05',2,10)

INSERT INTO KETQUA VALUES('B01','01',1,7)
INSERT INTO KETQUA VALUES('B01','03',1,2.5)
INSERT INTO KETQUA VALUES('B01','03',2,5)

INSERT INTO KETQUA VALUES('B02','02',1,6)
INSERT INTO KETQUA VALUES('B02','04',1,10)
SELECT * FROM KETQUA


--7.1
SELECT * FROM DMSV WHERE NOISINH IN(
  SELECT NOISINH FROM DMSV
  WHERE TENSV LIKE N'HẢI'
) AND TENSV NOT LIKE N'HẢI'


--7.2
SELECT * FROM DMSV AS SV,DMKHOA AS K
WHERE HOCBONG>(
  SELECT SUM(HOCBONG)
  FROM DMSV AS DM,DMKHOA AS K
  WHERE DM.MAKHOA=K.MAKHOA AND TENKHOA LIKE N'ANH VĂN'
  GROUP BY DM.MAKHOA
) AND SV.MAKHOA=K.MAKHOA AND TENKHOA NOT LIKE N'ANH VĂN'

--7.3
SELECT * FROM DMSV AS SV,DMKHOA AS K
WHERE HOCBONG>(
  SELECT MAX(HOCBONG)
  FROM DMSV AS DM,DMKHOA AS K
  WHERE DM.MAKHOA=K.MAKHOA AND TENKHOA LIKE N'ANH VĂN'
  GROUP BY DM.MAKHOA
) AND SV.MAKHOA=K.MAKHOA AND TENKHOA NOT LIKE N'ANH VĂN'

--7.4
SELECT * FROM DMMH AS MH,DMSV AS SV,KETQUA AS KQ
WHERE DIEM>(
  SELECT MAX(DIEM)
  FROM DMMH AS MH,DMSV AS SV,KETQUA AS KQ
  WHERE KQ.MASV=SV.MASV AND KQ.MAMH=MH.MAMH AND TENMH LIKE N'CƠ SỞ DỮ LIỆU' AND LANTHI=1
  GROUP BY LANTHI
) AND KQ.MASV=SV.MASV AND KQ.MAMH=MH.MAMH AND TENMH LIKE N'CƠ SỞ DỮ LIỆU' AND LANTHI=2

--7.5
SELECT TENSV,TENMH,DIEM
FROM KETQUA K1,DMSV SV,DMMH MH
WHERE SV.MASV=K1.MASV
AND DIEM>=ALL(
  SELECT DIEM
  FROM KETQUA K2
  WHERE K1.MASV=K2.MASV
)
AND K1.MAMH=MH.MAMH
--7.6
SELECT TENMH,COUNT(DISTINCT MASV) AS SL
FROM DMMH AS MH,KETQUA AS KQ
WHERE MH.MAMH=KQ.MAMH
GROUP BY MH.MAMH,TENMH
HAVING COUNT(DISTINCT MASV) >=ALL (
  SELECT COUNT(DISTINCT KQ.MASV)
  FROM KETQUA AS KQ,DMMH AS MH
  WHERE MH.MAMH=KQ.MAMH
  GROUP BY KQ.MAMH
)
--7.7
SELECT TENKHOA,COUNT(DISTINCT MASV) AS SL
FROM DMKHOA AS K,DMSV AS SV
WHERE K.MAKHOA =SV.MAKHOA AND PHAI=0
GROUP BY SV.MAKHOA,TENKHOA
HAVING COUNT(DISTINCT MASV)>=ANY(
  SELECT COUNT(DISTINCT MASV)
  FROM DMSV
  WHERE PHAI=0
  GROUP BY MAKHOA
)
--7.8
SELECT TENKHOA,COUNT(DISTINCT SV.MASV) AS SL
FROM DMKHOA AS K,DMSV AS SV
WHERE K.MAKHOA=SV.MAKHOA AND HOCBONG!=0
GROUP BY SV.MAKHOA,TENKHOA
HAVING COUNT(DISTINCT SV.MASV)>=ANY(
  SELECT COUNT(DISTINCT MASV)
  FROM DMSV
  WHERE HOCBONG!=0
  GROUP BY MAKHOA
)

--7.9
SELECT TENKHOA,COUNT(DISTINCT MASV) AS SL
FROM DMKHOA AS K,DMSV AS SV
WHERE K.MAKHOA=SV.MAKHOA AND HOCBONG!=0
GROUP BY SV.MAKHOA,TENKHOA
HAVING COUNT(DISTINCT MASV)>=ALL(
  SELECT COUNT(DISTINCT MASV)
  FROM DMSV
  WHERE HOCBONG!=0
  GROUP BY MAKHOA
)
--7.10
SELECT TENMH,COUNT(DISTINCT MASV) AS SL
FROM DMMH AS MH,KETQUA AS KQ
WHERE MH.MAMH=KQ.MAMH AND DIEM<5 AND LANTHI=1
GROUP BY MH.MAMH,TENMH
HAVING COUNT(DISTINCT MASV)>=ALL(
  SELECT COUNT(DISTINCT MASV)
  FROM KETQUA AS KQ,DMMH AS MH
  WHERE MH.MAMH=KQ.MAMH AND DIEM<5 AND LANTHI=1
  GROUP BY KQ.MAMH
)
--7.11.Cho biết 3 sinh viên có học nhiều môn nhất.
SELECT SV.MASV,TENSV,COUNT(DISTINCT MAMH) AS SL
FROM DMSV AS SV,KETQUA AS KQ
WHERE SV.MASV=KQ.MASV
GROUP BY SV.MASV,TENSV
HAVING COUNT(DISTINCT MAMH)>=ALL(
  SELECT COUNT(DISTINCT MAMH)
  FROM KETQUA
  GROUP BY MASV
)
